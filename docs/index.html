<!doctype html>
<html>
    <head>
        <script src="https://pixijs.download/release/pixi.js"></script>
        <style>
            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <input id="playerName" type="text" placeholder="Player Name">
        <input id="playerNameSubmit" type="button" value="Join">

        <script type="module">

            // ----------------------------------------------------------------------------------------------//
            // --------------------------------------- firebase code  ---------------------------------------//
            // ----------------------------------------------------------------------------------------------//

            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.4/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.4/firebase-analytics.js";
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries

            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
                apiKey: "AIzaSyBRtAuqGuk95gVVuFnIpHkxZNrnuMBcyd8",
                authDomain: "itk-winter-wonderwar.firebaseapp.com",
                databaseURL: "https://itk-winter-wonderwar-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "itk-winter-wonderwar",
                storageBucket: "itk-winter-wonderwar.appspot.com",
                messagingSenderId: "976506969988",
                appId: "1:976506969988:web:d983e49dce9ff3185d07d1",
                measurementId: "G-G3Q6SKKYKB"
            };

            // Initialize Firebase
            const firebaseApp = initializeApp(firebaseConfig);
            const analytics = getAnalytics(firebaseApp);

            import { getDatabase, ref, set, get, child, update, remove } from "https://www.gstatic.com/firebasejs/9.6.4/firebase-database.js";

            const db = getDatabase();


            // ----------------------------------------------------------------------------------------------//
            // ------------------------------------- pixiJS game code  --------------------------------------//
            // ----------------------------------------------------------------------------------------------//


            let app = new PIXI.Application({ width: 1058, height: 705 });

            let player = {
                x: 0.0,
                y: 0.0
            };

            const tfPlayerName = document.getElementById('playerName');
            const btnPlayerName = document.getElementById('playerNameSubmit');

            


            let players = {};
            players[tfPlayerName.value] = {x: 0.0, y: 0.0};

            function joinGame() {
                set(ref(db, "players/" + tfPlayerName.value), {
                    "x": player.x,
                    "y": player.y
                })
                .then(() => {
                    console.log("Data 'players/"+tfPlayerName.value+"' stored successfully");
                    tfPlayerName.classList.add('hidden');
                    btnPlayerName.classList.add('hidden');
                    game();
                })
                .catch((error) => {
                    console.log("set data error: " + error);
                    alert('Failed to join! Please try again.');
                });
            }

            btnPlayerName.addEventListener('click', joinGame);
            let bg = PIXI.Sprite.from('winter.jpg');
            bg.scale.set(0.5, 0.5);


            // ----------------------------------------------------------------------------------------------//
            // ------------------------------------- pixiJS game logic --------------------------------------//
            // ----------------------------------------------------------------------------------------------//
            function game() {

                const intervalUpdate = setInterval(() => {
                    update(ref(db, "players/" + tfPlayerName.value), {
                        "x": player.x,
                        "y": player.y
                    })
                    .then(() => {
                        
                    })
                    .catch(() => {
                        console.log('update data error: ' + error);
                    });
                }, 200);

                const intervalGet = setInterval(() => {
                    const dbRef = ref(db);

                    get(child(dbRef, 'players')).then((snapshot) => {
                        if (snapshot.exists()) {
                            snapshot.forEach((snap) => {
                                if (!(snap.key in players)) players[snap.key] = {};
                                players[snap.key].x = snap.val().x;
                                players[snap.key].y = snap.val().y;
                            });
                        }
                        else {
                            console.log('get data failed: No data found');
                        }
                    }).catch((error) => {
                        console.log('get data error: ' + error);
                    });
                }, 200);

                const keyCode = {
                    w: 87,
                    a: 65,
                    s: 83,
                    d: 68,
                }

                let w = false;
                let a = false;
                let s = false;
                let d = false;

                function onKey(key, down) {
                    switch(key.keyCode) {
                        case keyCode.w:
                            key.w = down;
                            w = down;
                            break;
                        case keyCode.a:
                            key.a = down;
                            a = down;
                            break;
                        case keyCode.s:
                            key.s = down;
                            s = down;
                            break;
                        case keyCode.d:
                            key.d = down;
                            d = down;
                            break;
                        default:
                            console.log('Unbound key: ' + key.keyCode);
                    }
                }
                document.addEventListener('keydown', (key) => {onKey(key, true)});
                document.addEventListener('keyup', (key) => {onKey(key, false)});

                
                document.body.appendChild(app.view);
                app.stage.addChild(bg);

                let time_elapsed = 0.0;
                app.ticker.add((delta) => {
                    time_elapsed += delta;

                    for (const [key, value] of Object.entries(players)) {
                        if (value.sprite === undefined) {
                            let tmpsprite = PIXI.Sprite.from('ITK_nat_santa.png');
                            tmpsprite.scale.set(0.5, 0.5);
                            app.stage.addChild(tmpsprite);
                            value.sprite = tmpsprite;
                        }
                    }

                    let dx = 0.0;
                    let dy = 0.0;
                    if (w) {
                        dy -= 10 * delta;
                    }
                    if (s) {
                        dy += 10 * delta;
                    }
                    if (a) {
                        dx -= 10 * delta;
                    }
                    if (d) {
                        dx += 10 * delta;
                    }

                    player.x += dx;
                    player.y += dy;

                    let i = 0;
                    for (const [key, value] of Object.entries(players)) {
                        if (key !== tfPlayerName.value) {
                            value.sprite.x = value.x;
                            value.sprite.y = value.y;
                        } else {
                            value.sprite.x = player.x;
                            value.sprite.y = player.y;
                        }
                    }
                });
            }

        </script>
    </body>
</html>

<!--


    function setData() {
                set(ref(db, "text"), {
                    "content_variable_name": bigOne.value
                })
                .then(() => {
                    console.log("Data stored successfully");
                })
                .catch((error) => {
                    console.log("set data error: " + error);
                });
            }

            function updateData() {
                update(ref(db, 'text'), {
                    content_variable_name
                })
                .then(() => {
                    console.log("Data updated successfully");
                })
                .catch(() => {
                    console.log('update data error: ' + error);
                });
            }

            function getData() {
                const dbRef = ref(db);

                get(child(dbRef, 'text')).then((snapshot) => {
                    if (snapshot.exists()) {
                        bigOne.value = snapshot.val().content_variable_name;
                    }
                    else {
                        console.log('get data failed: No data found');
                    }
                }).catch((error) => {
                    console.log('get data error: ' + error);
                });
            }

            function removeData() {
                remove(ref(db, 'text'), {
                    content_variable_name
                })
                .then(() => {
                    console.log("Data removed successfully");
                })
                .catch(() => {
                    console.log('remove data error: ' + error);
                });
            }


-->